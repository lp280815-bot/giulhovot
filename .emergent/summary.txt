<analysis>**original_problem_statement:**
The user requested to build a web application based on an initial Python script for a Streamlit app designed for debt aging (גיול חובות) analysis. The script's purpose is to process Excel files, categorize transactions based on amount matching, and identify items needing follow-up.

PRODUCT REQUIREMENTS:
1.  **Core Logic:** Implement the transaction matching logic from the provided script.
2.  **UI/UX:** Create a modern UI, allow Excel file upload, display categorized statistics, and show details in filterable/sortable tables.
3.  **Supplier Management:** Implement full CRUD functionality, including bulk import/export from Excel.
4.  **File Handling:** Allow downloading the processed Excel file with colored cells and correctly handle Hebrew filenames.
5.  **Email & Actions:**
    *   Add an actions column to tables for operations like matching, removing, or moving items.
    *   Implement a feature to generate and send emails for missing invoices.
    *   Integrate with Microsoft Outlook for sending emails directly from the application using the user's account (OAuth2).
6.  **State Persistence:** Ensure processing results are not lost on page refresh.
7.  **Advanced Filtering & Actions:** Implement complex business logic within a new Special Handling/Payment category, including calculated payment dates and generating new documents (PDF/Excel).

**User's preferred language**: Hebrew (עברית). The next agent MUST respond in Hebrew.

**what currently exists?**
A full-stack application with a React frontend and a FastAPI backend. The application successfully implements a wide range of features:
*   **Core Processing:** Uploading an Excel file, processing it according to the debt aging logic, and displaying statistics for each category.
*   **Interactive UI:** Statistics are shown on clickable buttons that expand to reveal detailed, sortable, and filterable tables.
*   **Supplier Management:** A dedicated tab provides full CRUD operations for suppliers, including bulk import/export.
*   **Email Integration:** A full Microsoft Graph API (OAuth2) integration allows users to connect their Outlook accounts to send emails directly from the app.
*   **Advanced Actions:**
    *   A modal allows sending pre-formatted emails to suppliers for missing invoices, consolidating multiple transfers into a single email.
    *   The Emails to Supplier table is grouped by supplier for clarity.
    *   Items are automatically removed from lists after an email or WhatsApp message is sent.
    *   Users can add or update supplier information directly from the email modal.
*   **State Persistence:** Application state (processed file results) is saved to , so data persists through page refreshes. A Refresh button allows the user to clear the state and start over.

**Last working item**:
*   **Last item agent was working:** The agent began implementing the second part of a large, multi-step feature request from the user. This part involves creating a detailed, expandable view for the לטיפול מיוחד/תשלום (Special Handling/Payment) category. The agent has already updated the backend to extract the necessary new data columns (, ) from the uploaded Excel file.
*   **Status:** IN PROGRESS
*   **Agent Testing Done:** N
*   **Which testing method agent to use?** Frontend testing agent. After the frontend changes are complete, the agent should test the full flow: upload an Excel file containing the new columns, click the Special Handling/Payment button, and verify the details table expands and displays all the new columns correctly.
*   **User Testing Done:** N

**All Pending/In progress Issue list**:
*   None. The current work is feature development, not bug fixing.

**In progress Task List**:
*   **Task 1 (P0):** Complete the details view for the Special Handling/Payment category.
    *   **Where to resume:** .
    *   **What needs to be done:**
        1.  Make the לטיפול מיוחד/תשלום button clickable, similar to other category buttons, to toggle the display of a details table.
        2.  Render the details table for this category, ensuring it includes the newly added columns (, ) alongside the existing ones (, , , ).
    *   **What will be achieved with this?** This will complete the second major part of the user's new feature request.
    *   **Status:** IN PROGRESS
    *   **Should Test frontend/backend/both after fix?** Frontend
    *   **Blocked on something:** None.

**Upcoming and Future Tasks**
*   **Upcoming Tasks (from user request in message #535):**
    *   **(P1) Actions for Special Handling:** In the new details view for Special Handling/Payment, implement a dropdown with the following actions:
        *    (Payment): Generate an Excel/PDF list for payment, with a payment date calculated based on new supplier payment terms.
        *    (Make Command): Move the selected row to the לעשות פקודה category.
        *    (Request Account Statement): Create a new category and flow similar to Emails to Supplier but with a different email template. This will require adding a company registration number (ח.פ) field to settings and date range selectors to the email modal.
    *   **(P2) Enhance Supplier Management:**
        *   Add a Payment Terms Code () column to the Supplier Management tab and database.
        *   Implement the logic to calculate the payment date based on this code (e.g., invoice date + 60 days, adjusted to the 10th of the month).

**Completed work in this session**
*   **Recently completed:**
    *   **Amount Filter Fix:** Implemented the amount filter to work with a +/- 2 tolerance and ignore signs (absolute value).
    *   **Microsoft OAuth2 Integration:** Fully implemented Microsoft authentication for sending emails via Graph API, including storing credentials and managing the token lifecycle.
    *   **Email Workflow Enhancements:**
        *   Consolidated multiple outstanding transfers for the same supplier into a single email.
        *   Grouped the Emails to Supplier table by supplier.
        *   Added logic to remove items from the list after an email is sent.
        *   Allowed highlighting text in the email body (bold, turquoise color).
    *   **State Persistence:** Added functionality to save processing results in  to survive page refreshes, and added a Refresh button to clear the state.
    *   **Inline Supplier Management:** Added the ability to create or update a supplier's details directly from the email-sending modal.
    *   **WhatsApp Flow:** Implemented a confirmation dialog to remove a supplier from the list after a WhatsApp message has been sent.
    *   **UI/UX:** Added and refined numerous UI elements, including action dropdowns, new buttons, settings fields, and modal enhancements based on user feedback.

**Earlier issues found/mentioned but not fixed**
*   None.

**Known issue recurrence from previous fork**
*   None.

**Code Architecture**


**Key Technical Concepts**
*   **Frontend:** React, Tailwind CSS, 
*   **Backend:** FastAPI, Motor (async MongoDB driver), , 
*   **Database:** MongoDB
*   **Authentication:** Microsoft OAuth2 for third-party email sending.
*   **State Management:** React state (, ) combined with browser  for persistence.

**key DB schema**
*   : 
*   : 
*   : Stores the detailed rows for each category for a given processing ID.
*   : 

**changes in tech stack**
*   Added  to the backend for making requests to the Microsoft Graph API.
*   Implicitly uses  library patterns for handling Microsoft OAuth2 flow.

**All files of reference**
*   : The monolithic backend file containing all API logic, Excel processing, and the entire Microsoft OAuth2 flow.
*   : The monolithic frontend file containing all UI components, state management, and logic for the entire application. It has grown significantly and is becoming difficult to manage.
*   : Now contains critical secrets for the Microsoft OAuth2 integration.

**Areas that need refactoring**:
*   : This file is now over 2100 lines long. It urgently needs to be broken down into smaller components (e.g., , , , , ) to improve readability and maintainability.
*   : This file has also grown significantly. The logic for Excel processing, database interactions, and the Microsoft auth flow could be separated into distinct modules.

**key api endpoints**
*   : Processes the main Excel file.
*   : Moves a row between categories.
*   : Deletes a single row from a category's details.
*   : Deletes all rows for a given supplier from a specific category.
*   : Initiates the Microsoft OAuth2 login flow.
*   : The callback URL for the OAuth2 flow.
*   : Sends an email using the stored user token via Microsoft Graph API.

**Critical Info for New Agent**
*   **You must communicate with the user in Hebrew.**
*   The immediate task is to continue the feature implementation started by the previous agent: rendering the details view for the Special Handling/Payment category in . The backend work for this is already done.
*   The Microsoft OAuth2 integration is live. The credentials are in . The Redirect URI is configured for the preview environment. Any changes to deployment URLs will require updating the Redirect URI in the user's Azure App Registration.
*   The frontend code in  is extremely long. Use search and view specific line ranges to navigate it effectively. Be very careful when making changes to avoid breaking existing functionality.

**documents and test reports created in this job**
*   None.

**Last 10 User Messages and any pending HUMAN messages**
1.  **User (P1):** Asks to save processing results until the app is closed or a refresh button is clicked.
2.  **User (P2):** Asks to make the Special Handling/Payment button expandable to show a details table with specific columns.
3.  **User (P3):** Details a new dropdown menu for the Special Handling category with options for Payment, Make Command, and Request Account Statement, each with complex sub-requirements.
4.  **User (P4):** Requests adding Payment Terms to supplier management to calculate payment dates.
5.  **Agent:** Asks the user to prioritize the list of requests.
6.  **User:** Prioritizes request #1.
7.  **Agent:** Completes request #1 (state persistence and refresh button).
8.  **User:** Confirms to continue to the next task.
9.  **Agent:** Starts working on request #2 (details for Special Handling).
10. **Agent:** Updates the backend to extract new data columns needed for request #2.

**Project Health Check:**
*   **Broken:** The Special Handling/Payment details view is partially implemented (backend is done, frontend is not).
*   **Mocked:** None.

**3rd Party Integrations**
*   **Microsoft Graph API:** Used for sending emails via user's Outlook account. Requires user consent via OAuth2 flow.
*   **openpyxl:** Used for reading/writing Excel files on the backend.

**Testing status**
*   **Testing agent used after significant changes:** NO
*   **Troubleshoot agent used after agent stuck in loop:** NO
*   **Test files created:** None
*   **Known regressions:** The linter identified a missing dependency in a  hook in . The agent bypassed this, but it could cause subtle bugs.

**Credentials to test flow:**
*   Microsoft OAuth requires user interaction. The , , and  are stored in .

**What agent forgot to execute**
*   The agent acknowledged but did not fix a linter warning regarding a missing dependency in a  hook in .</analysis>
